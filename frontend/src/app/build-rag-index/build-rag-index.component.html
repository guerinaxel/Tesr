<section class="rag-builder">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Build RAG Index</mat-card-title>
      <mat-card-subtitle>
        Fournissez un chemin racine (facultatif) pour lancer la construction de l'index côté backend.
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form class="rag-builder__form" (ngSubmit)="onSubmit()">
        <mat-form-field appearance="outline">
          <mat-label>Project root</mat-label>
          <input
            matInput
            id="rootInput"
            name="root"
            type="text"
            [(ngModel)]="root"
            placeholder="/workspace/project"
            [disabled]="isSubmitting || isLoadingRoot"
            data-cy="root-input"
          />
          <mat-icon matSuffix aria-hidden="true">folder</mat-icon>
          <mat-hint>
            Optionnel&nbsp;: laissez vide pour la racine par défaut.
            <ng-container *ngIf="lastUsedRoot">Dernier chemin utilisé : {{ lastUsedRoot }}</ng-container>
          </mat-hint>
        </mat-form-field>

        <button
          mat-flat-button
          color="primary"
          type="submit"
          [disabled]="isSubmitting"
          data-cy="launch-button"
        >
          <mat-progress-spinner
            *ngIf="isSubmitting"
            mode="indeterminate"
            diameter="18"
            strokeWidth="3"
          ></mat-progress-spinner>
          <mat-icon *ngIf="!isSubmitting" aria-hidden="true">rocket_launch</mat-icon>
          <span>{{ isSubmitting ? 'Envoi...' : 'Lancer la construction' }}</span>
        </button>

        <button
          mat-stroked-button
          color="primary"
          type="button"
          [disabled]="isSubmitting || !lastUsedRoot"
          (click)="onRebuild()"
          data-cy="rebuild-button"
        >
          <mat-icon aria-hidden="true">replay</mat-icon>
          <span>Reconstruire avec le dernier chemin</span>
        </button>
      </form>

      <section *ngIf="progress" class="rag-builder__progress" data-cy="build-progress">
        <div class="rag-builder__progress__header">
          <div class="rag-builder__progress__title">
            <mat-icon aria-hidden="true">
              {{ progress.status === 'running' ? 'sync' : progress.status === 'completed' ? 'check_circle' : 'info' }}
            </mat-icon>
            <div>
              <p class="rag-builder__progress__message" data-cy="progress-message">{{ progress.message }}</p>
              <p class="rag-builder__progress__root" *ngIf="progress.root">Chemin utilisé : {{ progress.root }}</p>
            </div>
          </div>
          <span class="rag-builder__progress__value" data-cy="progress-percent">{{ progress.percent }}%</span>
        </div>

        <mat-progress-bar
          mode="determinate"
          color="primary"
          [value]="progress.percent"
          data-cy="progress-bar"
        ></mat-progress-bar>

        <div
          class="rag-builder__progress__status"
          [ngClass]="{
            'rag-builder__progress__status--running': progress.status === 'running',
            'rag-builder__progress__status--success': progress.status === 'completed',
            'rag-builder__progress__status--error': progress.status === 'error'
          }"
        >
          {{ progress.status === 'running' ? 'Construction en cours' : progress.status === 'completed' ? 'Terminé' :
          progress.status === 'error' ? 'Erreur' : 'En attente' }}
        </div>
      </section>

      <div
        *ngIf="toast"
        class="toast"
        [ngClass]="{
          'toast--success': toast.type === 'success',
          'toast--error': toast.type === 'error'
        }"
        role="status"
        data-cy="toast"
      >
        <mat-icon aria-hidden="true">
          {{ toast.type === 'success' ? 'check_circle' : 'error' }}
        </mat-icon>
        <span>{{ toast.message }}</span>
      </div>
    </mat-card-content>
  </mat-card>
</section>
